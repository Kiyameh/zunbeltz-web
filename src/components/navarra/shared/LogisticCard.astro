---
import type { AccessInfo, UtmCoordinates } from '@/schemas/shared';
import { utmToLatLong } from '@/utils/coordinate-utils';
import { Icon } from "astro-icon/components";

interface Props {
  entryPoint?: UtmCoordinates
  exitPoint?: UtmCoordinates
  accessInfo?: AccessInfo
  returnInfo?: AccessInfo
}

const { entryPoint, exitPoint, accessInfo, returnInfo } = Astro.props;

// Format numbers with thousands separator
function formatNumber(num: number): string {
  return num.toLocaleString("es-ES");
}

// Prepare coordinates with computed lat/long if needed
interface CoordData {
  label: string;
  icon: string;
  utm: UtmCoordinates;
  lat: number;
  lng: number;
}

const coordinates: CoordData[] = [];

if (entryPoint) {
  const geo = entryPoint.latitude && entryPoint.longitude 
    ? { latitude: entryPoint.latitude, longitude: entryPoint.longitude }
    : utmToLatLong(entryPoint);
  coordinates.push({
    label: "Entrada",
    icon: "map-down",
    utm: entryPoint,
    lat: geo.latitude,
    lng: geo.longitude
  });
}

if (exitPoint) {
  const geo = exitPoint.latitude && exitPoint.longitude 
    ? { latitude: exitPoint.latitude, longitude: exitPoint.longitude }
    : utmToLatLong(exitPoint);
  coordinates.push({
    label: "Salida",
    icon: "map-up",
    utm: exitPoint,
    lat: geo.latitude,
    lng: geo.longitude
  });
}

if (accessInfo?.parking) {
  const geo = accessInfo.parking.latitude && accessInfo.parking.longitude 
    ? { latitude: accessInfo.parking.latitude, longitude: accessInfo.parking.longitude }
    : utmToLatLong(accessInfo.parking);
  coordinates.push({
    label: "Parking acceso",
    icon: "parking-circle",
    utm: accessInfo.parking,
    lat: geo.latitude,
    lng: geo.longitude
  });
}

if (returnInfo?.parking) {
  const geo = returnInfo.parking.latitude && returnInfo.parking.longitude 
    ? { latitude: returnInfo.parking.latitude, longitude: returnInfo.parking.longitude }
    : utmToLatLong(returnInfo.parking);
  coordinates.push({
    label: "Parking retorno",
    icon: "parking",
    utm: returnInfo.parking,
    lat: geo.latitude,
    lng: geo.longitude
  });
}

// Only render if we have at least one coordinate
const shouldRender = coordinates.length > 0;
---

{
  shouldRender && (
    <div class="card">
      <div class="header">
        <h3 class="title">Localización</h3>
           <p class="datum-info">ETRS89</p>
        <div class="toggle-container">
           <button class="toggle-btn active" data-system="utm">UTM</button>
           <button class="toggle-btn" data-system="latlong">Lat/Long</button>
        </div>
      </div>
      <div class="card-content">
        <div class="location-container">
          <div class="stats-list">
            {coordinates.map((coord) => (
              <div class="stat-item">
                <div class="stat-content">
                  <span class="stat-label">{coord.label}</span>
                  <div class="coordinates-wrapper">
                    <!-- UTM Format -->
                    <div class="utm-coords coord-block">
                      <div class="coord-values">
                        <div class="coord-line">
                          <span class="coord-axis">X ({coord.utm.zone}T):</span>
                          <span class="coord-number">{formatNumber(coord.utm.easting)}</span>
                        </div>
                        <div class="coord-line">
                          <span class="coord-axis">Y ({coord.utm.zone}T):</span>
                          <span class="coord-number">{formatNumber(coord.utm.northing)}</span>
                        </div>
                      </div>
                    </div>
                    <!-- Lat/Long Format -->
                    <div class="latlong-coords coord-block" style="display: none;">
                      <div class="coord-values">
                        <span class="coord-number">{coord.lat.toFixed(5)}°, {coord.lng.toFixed(5)}°</span>
                      </div>
                    </div>
                  </div>
                </div>
                <a
                  href={`https://www.google.com/maps?q=${coord.lat},${coord.lng}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="map-link"
                  title="Ver en Google Maps"
                >
                  <Icon name={coord.icon} class="icon-size" />
                </a>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  )
}

<script>
  function initLocationToggle() {
    const toggleButtons = document.querySelectorAll(".toggle-btn");
    const utmCoords = document.querySelectorAll(".utm-coords");
    const latlongCoords = document.querySelectorAll(".latlong-coords");

    toggleButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const system = button.getAttribute("data-system");

        // Update active state
        toggleButtons.forEach((btn) => btn.classList.remove("active"));
        button.classList.add("active");

        // Toggle coordinate display
        if (system === "utm") {
          utmCoords.forEach((coord) => {
            (coord as HTMLElement).style.display = "block";
          });
          latlongCoords.forEach((coord) => {
            (coord as HTMLElement).style.display = "none";
          });
        } else {
          utmCoords.forEach((coord) => {
            (coord as HTMLElement).style.display = "none";
          });
          latlongCoords.forEach((coord) => {
            (coord as HTMLElement).style.display = "block";
          });
        }
      });
    });
  }

  // Initialize on page load
  document.addEventListener("astro:page-load", initLocationToggle);
  
  // Also initialize immediately if script loads after page
  if (document.readyState === "complete" || document.readyState === "interactive") {
    initLocationToggle();
  }
</script>

<style>
  /* Card */
  .card {
    background: var(--color-surface-100);
    border: 2px solid var(--color-border-100);
    border-radius: var(--radius-xl);
    padding: 1.5rem;
    font-family: var(--font-paragraph);
  }

  .header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .title {
    font-family: var(--font-title);
    font-size: 1.25rem;
    margin: 0;
  }

  .datum-info{
    font-size: 0.8rem;
    color: var(--color-content-200)
  }

  .card-content {
    color: var(--color-content-300);
    font-size: 0.9375rem;
    line-height: 1.6;
  }

  .location-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  /* Toggle Buttons */
  .toggle-container {
    display: flex;
    gap: 0.25rem;
    justify-content: flex;
    margin-bottom: 0.5rem;
  }

  .toggle-btn {
    padding: 0.25rem 0.5rem;
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    font-family: var(--font-paragraph);
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--color-content-200);
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .toggle-btn:hover {
    color: var(--color-content-400);
    background: var(--color-surface-200);
  }

  .toggle-btn.active {
    color: var(--color-primary-300);
    background: var(--color-surface-200);
    font-weight: 600;
  }

  .stats-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--color-border-100);
  }

  .stat-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }

  .stat-content {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-direction: row;
    gap: 1rem;
  }

  .stat-label {
    font-family: var(--font-paragraph);
    font-size: 0.875rem;
    color: var(--color-content-200);
    max-width: 80px;
  }

  .coordinates-wrapper {
    display: flex;
    flex-direction: column;
  }

  .coord-number {
    font-family: var(--font-title);
    font-size: 0.875rem;
    margin-left: 1rem;
    color: var(--color-primary-300);
    font-family: "Courier New", monospace;
  }

  /* Map Link */
  .map-link {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.4rem;
    color: var(--color-primary-300);
    background: var(--color-surface-200);
    border-radius: var(--radius-md);
    transition: all 0.2s ease;
    text-decoration: none;
    flex-shrink: 0;
  }

  .map-link:hover {
    background: var(--color-primary-300);
    color: white;
    transform: translateY(-2px);
  }

  .map-link :global(.icon-size) {
    width: 22px;
    height: 22px;
    display: block;
  }
</style>
