---

interface Props {
  entryPoint?: {
    zone: number;
    hemisphere: "N" | "S";
    easting: number;
    northing: number;
    latitude: number;
    longitude: number;
    altitude?: number;
  };
  exitPoint?: {
    zone: number;
    hemisphere: "N" | "S";
    easting: number;
    northing: number;
    latitude: number;
    longitude: number;
    altitude?: number;
  };
}

const { entryPoint, exitPoint } = Astro.props;

// Format numbers with thousands separator
function formatNumber(num: number): string {
  return num.toLocaleString("es-ES");
}
---

{
  (entryPoint || exitPoint) && (
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Localización</h3>
      </div>
      <div class="card-content">
        <div class="location-container">
        <!-- Coordinate System Toggle in header -->
        <div class="header-with-toggle">
          <div class="toggle-container">
            <button class="toggle-btn active" data-system="utm">UTM</button>
            <button class="toggle-btn" data-system="latlong">Lat/Long</button>
          </div>
        </div>

        <div class="stats-list">
          {entryPoint && (
            <div class="stat-item">
              <div class="stat-content">
                <span class="stat-label">Entrada</span>
                <div class="coordinates-wrapper">
                  <!-- UTM Format -->
                  <div class="utm-coords coord-block">
                    <div class="coord-system">ETRS89 ({entryPoint.zone}T)</div>
                    <div class="coord-values">
                      <div class="coord-line">
                        <span class="coord-axis">X:</span>
                        <span class="coord-number">{formatNumber(entryPoint.easting)}</span>
                      </div>
                      <div class="coord-line">
                        <span class="coord-axis">Y:</span>
                        <span class="coord-number">{formatNumber(entryPoint.northing)}</span>
                      </div>
                    </div>
                  </div>
                  <!-- Lat/Long Format -->
                  <div class="latlong-coords coord-block" style="display: none;">
                    <div class="coord-system">ETRS89</div>
                    <div class="coord-values">
                      <span class="coord-number">{entryPoint.latitude.toFixed(5)}°, {entryPoint.longitude.toFixed(5)}°</span>
                    </div>
                  </div>
                </div>
              </div>
              <a
                href={`https://www.google.com/maps?q=${entryPoint.latitude},${entryPoint.longitude}`}
                target="_blank"
                rel="noopener noreferrer"
                class="map-link"
                title="Ver en Google Maps"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                  <circle cx="12" cy="10" r="3" />
                </svg>
              </a>
            </div>
          )}
          {exitPoint && (
            <div class="stat-item">
              <div class="stat-content">
                <span class="stat-label">Salida</span>
                <div class="coordinates-wrapper">
                  <!-- UTM Format -->
                  <div class="utm-coords coord-block">
                    <div class="coord-system">ETRS89 ({exitPoint.zone}T)</div>
                    <div class="coord-values">
                      <div class="coord-line">
                        <span class="coord-axis">X:</span>
                        <span class="coord-number">{formatNumber(exitPoint.easting)}</span>
                      </div>
                      <div class="coord-line">
                        <span class="coord-axis">Y:</span>
                        <span class="coord-number">{formatNumber(exitPoint.northing)}</span>
                      </div>
                    </div>
                  </div>
                  <!-- Lat/Long Format -->
                  <div class="latlong-coords coord-block" style="display: none;">
                    <div class="coord-system">ETRS89</div>
                    <div class="coord-values">
                      <span class="coord-number">{exitPoint.latitude.toFixed(5)}°, {exitPoint.longitude.toFixed(5)}°</span>
                    </div>
                  </div>
                </div>
              </div>
              <a
                href={`https://www.google.com/maps?q=${exitPoint.latitude},${exitPoint.longitude}`}
                target="_blank"
                rel="noopener noreferrer"
                class="map-link"
                title="Ver en Google Maps"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                  <circle cx="12" cy="10" r="3" />
                </svg>
              </a>
            </div>
          )}
        </div>
      </div>
      </div>
    </div>
  )
}

<script>
  function initLocationToggle() {
    const toggleButtons = document.querySelectorAll(".toggle-btn");
    const utmCoords = document.querySelectorAll(".utm-coords");
    const latlongCoords = document.querySelectorAll(".latlong-coords");

    toggleButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const system = button.getAttribute("data-system");

        // Update active state
        toggleButtons.forEach((btn) => btn.classList.remove("active"));
        button.classList.add("active");

        // Toggle coordinate display
        if (system === "utm") {
          utmCoords.forEach((coord) => {
            (coord as HTMLElement).style.display = "block";
          });
          latlongCoords.forEach((coord) => {
            (coord as HTMLElement).style.display = "none";
          });
        } else {
          utmCoords.forEach((coord) => {
            (coord as HTMLElement).style.display = "none";
          });
          latlongCoords.forEach((coord) => {
            (coord as HTMLElement).style.display = "block";
          });
        }
      });
    });
  }

  // Initialize on page load
  document.addEventListener("astro:page-load", initLocationToggle);
  
  // Also initialize immediately if script loads after page
  if (document.readyState === "complete" || document.readyState === "interactive") {
    initLocationToggle();
  }
</script>

<style>
  /* Card */
  .card {
    background: var(--color-surface-100);
    border: 2px solid var(--color-border-100);
    border-radius: var(--radius-xl);
    padding: 1.5rem;
    font-family: var(--font-paragraph);
  }

  .card-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .card-title {
    font-family: var(--font-title);
    font-size: 1.25rem;
    color: var(--color-content-500);
    margin: 0;
  }

  .card-content {
    color: var(--color-content-300);
    font-size: 0.9375rem;
    line-height: 1.6;
  }

  .location-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  /* Toggle Buttons */
  .toggle-container {
    display: flex;
    gap: 0.25rem;
    justify-content: flex;
    margin-bottom: 0.5rem;
  }

  .toggle-btn {
    padding: 0.25rem 0.5rem;
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    font-family: var(--font-paragraph);
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--color-content-200);
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .toggle-btn:hover {
    color: var(--color-content-400);
    background: var(--color-surface-200);
  }

  .toggle-btn.active {
    color: var(--color-primary-300);
    background: var(--color-surface-200);
    font-weight: 600;
  }

  .stats-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--color-border-100);
  }

  .stat-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }

  .stat-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .stat-label {
    font-family: var(--font-paragraph);
    font-size: 0.875rem;
    color: var(--color-content-200);
  }

  .coordinates-wrapper {
    display: flex;
    flex-direction: column;
  }

  .coord-number {
    font-family: var(--font-title);
    font-size: 0.875rem;
    margin-left: 1rem;
    color: var(--color-primary-300);
    font-family: "Courier New", monospace;
  }

  /* Map Link */
  .map-link {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    color: var(--color-primary-300);
    background: var(--color-surface-200);
    border-radius: var(--radius-md);
    transition: all 0.2s ease;
    text-decoration: none;
    flex-shrink: 0;
  }

  .map-link:hover {
    background: var(--color-primary-300);
    color: white;
    transform: translateY(-2px);
  }

  .map-link svg {
    display: block;
  }
</style>
