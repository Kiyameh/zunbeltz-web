---
import { getCollection, type CollectionEntry } from "astro:content";
import HtmlLayout from "@/layouts/HtmlLayout.astro";
import type { MetaInfo } from "@/components/SEO/MetaInfo";
import MountainProperties from "@/components/navarra/mountains/MountainProperties.astro";
import RestrictionsCard from "@/components/navarra/shared/RestrictionsCard.astro";
import LogisticCard from "@/components/navarra/shared/LogisticCard.astro";
import ImageGallery from "@/components/navarra/shared/ImageGallery.astro";
import Breadcrumb from "@/components/ui/Breadcrumb.astro";
import HeroSection from "@/components/navarra/shared/HeroSection.astro";

export async function getStaticPaths() {
  const mountains = await getCollection("mountains");
  const hikings = await getCollection("hikings");

  return mountains.map((mountain) => {
    const relatedHikings = hikings.filter(
      (hiking) => hiking.data.mountain?.id === mountain.slug,
    );

    return {
      params: { slug: mountain.slug },
      props: { mountain, relatedHikings },
    };
  });
}

interface Props {
  mountain: CollectionEntry<"mountains">;
  relatedHikings: CollectionEntry<"hikings">[];
}

const { mountain, relatedHikings } = Astro.props;
const { Content: MountainContent } = await mountain.render();

const meta: MetaInfo = {
  pageTitle: `${mountain.data.name} | Montañas de Navarra | Zunbeltz`,
  pageDescription: mountain.data.description,
  pageTags: ["Montaña", "Navarra", "Senderismo", mountain.data.location],
  pageUrl: `https://zunbeltz.org/navarra/montañas/${mountain.slug}`,
};
---

<HtmlLayout metaInfo={meta}>
  <main>
    <article>
      <HeroSection
        title={mountain.data.name}
        description={mountain.data.description}
        photo={mountain.data.mainPhoto}
      />

      <div class="container">
        <Breadcrumb />
      </div>

      <div class="container">
        <div class="grid">
          <div class="main-column">
            <MountainProperties mountain={mountain.data} />
            <section class="markdown-content">
              <MountainContent />
            </section>

            <!-- Hiking Routes -->
            {
              relatedHikings.length > 0 && (
                <section class="hikings-section">
                  <h2 class="section-title">
                    Rutas de Senderismo ({relatedHikings.length})
                  </h2>
                  <div class="hikings-list">
                    {relatedHikings.map((hiking) => (
                      <a
                        href={`/navarra/senderismo/${hiking.slug}`}
                        class="hiking-card"
                      >
                        <div class="hiking-header">
                          <h3 class="hiking-name">{hiking.data.name}</h3>
                        </div>
                        {hiking.data.description && (
                          <p class="hiking-description">
                            {hiking.data.description}
                          </p>
                        )}
                        <div class="hiking-stats">
                          <span class="stat">
                            <strong>Distancia:</strong> {hiking.data.length} km
                          </span>
                          <span class="stat">
                            <strong>Desnivel:</strong>{" "}
                            {hiking.data.elevationGain} m
                          </span>
                        </div>
                      </a>
                    ))}
                  </div>
                </section>
              )
            }
          </div>

          <aside class="side-column">
            <RestrictionsCard restrictions={mountain.data.restrictions} />
            <LogisticCard entryPoint={mountain.data.coordinates} />
          </aside>
        </div>
      </div>

      <ImageGallery photos={mountain.data.additionalPhotos || []} />
    </article>
  </main>

  <style>
    /* Container */
    .container {
      max-width: 1300px;
      margin: 0 auto;
      padding: 0 1.5rem 3rem 1.5rem;
    }

    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 3rem;
    }

    .main-column {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .side-column {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    /* Responsive */
    @media (max-width: 968px) {
      .grid {
        grid-template-columns: 1fr;
        gap: 2rem;
      }

      .sidebar {
        order: -1;
      }

      .photo-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .multimedia {
        padding: 3rem 0;
      }

      .multimedia-title {
        font-size: 1.5rem;
      }
    }
    /* Hikings Section */
    .hikings-section {
      margin-top: 1rem;
    }

    .hikings-list {
      padding: 2rem 0;
      display: grid;
      gap: 1.5rem;
    }

    .hiking-card {
      padding: 1.5rem;
      background: var(--color-surface-100);
      border: 2px solid var(--color-border-100);
      border-radius: var(--radius-xl);
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .hiking-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--color-secondary-300);
    }

    .hiking-header {
      margin-bottom: 0.75rem;
    }

    .hiking-name {
      font-family: var(--font-title);
      font-size: 1.25rem;
      color: var(--color-content-500);
      margin: 0;
    }

    .hiking-description {
      font-family: var(--font-paragraph);
      font-size: 0.9rem;
      color: var(--color-content-300);
      line-height: 1.6;
      margin: 0 0 0.75rem 0;
    }

    .hiking-stats {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }

    .stat {
      font-family: var(--font-paragraph);
      font-size: 0.875rem;
      color: var(--color-content-300);
    }

    .stat strong {
      color: var(--color-content-400);
      font-weight: 600;
    }
  </style>
</HtmlLayout>
