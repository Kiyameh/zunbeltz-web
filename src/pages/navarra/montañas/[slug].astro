---
import { getCollection, getEntry, type CollectionEntry } from "astro:content";
import HtmlLayout from "@/layouts/HtmlLayout.astro";
import type { MetaInfo } from "@/components/SEO/MetaInfo";
import MountainCharacteristics from "@/components/navarra/mountains/MountainCharacteristics.astro";
import MountainLocationCard from "@/components/navarra/mountains/MountainLocationCard.astro";
import RestrictionsCard from "@/components/navarra/shared/RestrictionsCard.astro";
import ImageGallery from "@/components/navarra/shared/ImageGallery.astro";
import Breadcrumb from "@/components/ui/Breadcrumb.astro";
import HeroSection from "@/components/navarra/shared/HeroSection.astro";
import RouteCard from "@/components/navarra/shared/RouteCard.astro";
import PitchTable from "@/components/navarra/shared/PitchTable.astro";

export async function getStaticPaths() {
  const mountains = await getCollection("mountains");
  return mountains.map((mountain) => ({
    params: { slug: mountain.slug },
    props: { mountain },
  }));
}

interface Props {
  mountain: CollectionEntry<"mountains">;
}

const { mountain } = Astro.props;
const { Content } = await mountain.render();

// Resolver referencias a rutas usando getEntry
const hikingRoutes = mountain.data.hikingRoutes
  ? await Promise.all(mountain.data.hikingRoutes.map((ref) => getEntry(ref)))
  : [];

const technicalRoutes = mountain.data.technicalRoutes
  ? await Promise.all(mountain.data.technicalRoutes.map((ref) => getEntry(ref)))
  : [];

const meta: MetaInfo = {
  pageTitle: `${mountain.data.name} | Montañas de Navarra | Zunbeltz`,
  pageDescription: mountain.data.description,
  pageTags: ["Montaña", "Navarra", "Senderismo", mountain.data.location],
  pageUrl: `https://zunbeltz.org/navarra/montañas/${mountain.slug}`,
};
---

<HtmlLayout metaInfo={meta}>
  <main>
    <HeroSection
      title={mountain.data.name}
      description={mountain.data.description}
      photo={mountain.data.mainPhoto}
    />

    <!-- Breadcrumb -->
    <div class="container">
      <Breadcrumb />
    </div>

    <!-- Main Content -->
    <div class="content">
      <div class="container">
        <div class="grid">
          <!-- Left Column: Main Info -->
          <div class="main-column">
            <!-- Características Principales -->
            <MountainCharacteristics mountain={mountain.data} />

            <!-- Markdown Content -->
            <section class="section markdown-content">
              <Content />
            </section>

            <!-- Rutas Senderistas -->
            {
              hikingRoutes && hikingRoutes.length > 0 && (
                <section class="section routes-section">
                  <h2 class="section-title">Rutas Senderistas</h2>
                  <p class="section-intro">
                    Explora las rutas senderistas disponibles en{" "}
                    {mountain.data.name}. Haz clic en cada ruta para ver
                    información detallada, mapas y recomendaciones.
                  </p>
                  <div class="routes-list">
                    {hikingRoutes.map(
                      (route) =>
                        route && (
                          <a
                            href={`/navarra/senderismo/${route.slug}`}
                            class="route-link"
                          >
                            <div class="route-card-link">
                              <div class="route-header">
                                <h3 class="route-name">{route.data.name}</h3>
                                <span
                                  class={`difficulty-badge difficulty-${route.data.difficulty.toLowerCase().replace(/\s+/g, "-")}`}
                                >
                                  {route.data.difficulty}
                                </span>
                              </div>
                              <p class="route-description">
                                {route.data.description}
                              </p>
                              <div class="route-stats">
                                <span class="stat">
                                  <strong>Distancia:</strong>{" "}
                                  {route.data.length} km
                                </span>
                                <span class="stat">
                                  <strong>Desnivel:</strong>{" "}
                                  {route.data.elevationGain} m
                                </span>
                                <span class="stat">
                                  <strong>Duración:</strong>{" "}
                                  {route.data.duration.hours}h{" "}
                                  {route.data.duration.minutes}min
                                </span>
                              </div>
                              <span class="view-more">Ver ruta completa →</span>
                            </div>
                          </a>
                        ),
                    )}
                  </div>
                </section>
              )
            }

            <!-- Rutas Técnicas -->
            {
              technicalRoutes && technicalRoutes.length > 0 && (
                <section class="section routes-section">
                  <h2 class="section-title">Rutas Técnicas de Alpinismo</h2>
                  <p class="section-intro">
                    Descubre las rutas técnicas y de escalada en{" "}
                    {mountain.data.name}. Cada ruta incluye descripción de
                    largos, material necesario y croquis detallados.
                  </p>
                  <div class="routes-list">
                    {technicalRoutes.map(
                      (route) =>
                        route && (
                          <a
                            href={`/navarra/largos/${route.slug}`}
                            class="route-link"
                          >
                            <div class="route-card-link technical">
                              <div class="route-header">
                                <h3 class="route-name">{route.data.name}</h3>
                                <span class="grade-badge">
                                  {route.data.difficulty.number}
                                  {route.data.difficulty.letter}
                                  {route.data.difficulty.modifier || ""}
                                </span>
                              </div>
                              <p class="route-description">
                                {route.data.description}
                              </p>
                              <div class="route-stats">
                                <span class="stat">
                                  <strong>Desnivel:</strong>{" "}
                                  {route.data.elevationGain} m
                                </span>
                                <span class="stat">
                                  <strong>Duración:</strong>{" "}
                                  {route.data.duration.hours}h{" "}
                                  {route.data.duration.minutes}min
                                </span>
                                {route.data.climbingPitches && (
                                  <span class="stat">
                                    <strong>Largos:</strong>{" "}
                                    {route.data.climbingPitches.length}
                                  </span>
                                )}
                              </div>
                              <span class="view-more">Ver ruta completa →</span>
                            </div>
                          </a>
                        ),
                    )}
                  </div>
                </section>
              )
            }
          </div>

          <!-- Right Column: Sidebar -->
          <aside class="sidebar">
            <!-- Localización -->
            <MountainLocationCard coordinates={mountain.data.coordinates} />

            <!-- Restricciones -->
            <RestrictionsCard restrictions={mountain.data.restrictions} />
          </aside>
        </div>
      </div>
    </div>

    <!-- Multimedia Section -->
    <ImageGallery photos={mountain.data.additionalPhotos || []} />
  </main>
</HtmlLayout>

<style>
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  /* Content */
  .content {
    padding: 3rem 0;
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 3rem;
  }

  .main-column {
    min-width: 0;
  }

  .sidebar {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .section {
    margin-bottom: 2rem;
  }

  /* Markdown Content */
  .markdown-content {
    font-family: var(--font-paragraph);
    color: var(--color-content-300);
    line-height: 1.7;
  }

  .markdown-content :global(h2) {
    font-family: var(--font-title);
    font-size: 1.75rem;
    color: var(--color-content-500);
    margin: 2rem 0 1rem;
  }

  .markdown-content :global(h3) {
    font-family: var(--font-title);
    font-size: 1.375rem;
    color: var(--color-content-400);
    margin: 1.5rem 0 0.75rem;
  }

  .markdown-content :global(p) {
    margin-bottom: 1rem;
  }

  .markdown-content :global(ul),
  .markdown-content :global(ol) {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
  }

  .markdown-content :global(li) {
    margin-bottom: 0.5rem;
  }

  .markdown-content :global(strong) {
    color: var(--color-content-500);
    font-weight: 600;
  }

  .markdown-content :global(code) {
    background: var(--color-surface-200);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-family: "Courier New", monospace;
    font-size: 0.875em;
  }

  /* Routes Section */
  .routes-section {
    margin-top: 3rem;
  }

  .section-title {
    font-family: var(--font-title);
    font-size: 1.75rem;
    color: var(--color-content-500);
    margin: 0 0 0.75rem 0;
  }

  .section-intro {
    font-family: var(--font-paragraph);
    font-size: 1rem;
    color: var(--color-content-300);
    line-height: 1.6;
    margin: 0 0 1.5rem 0;
    padding: 1rem;
    background: var(--color-surface-100);
    border-left: 4px solid var(--color-secondary-400);
    border-radius: var(--radius-md);
  }

  .routes-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .route-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .route-card-link {
    background: var(--color-surface-100);
    border: 2px solid var(--color-border-100);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    transition: all 0.3s ease;
  }

  .route-card-link:hover {
    border-color: var(--color-secondary-400);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .route-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .route-name {
    font-family: var(--font-title);
    font-size: 1.25rem;
    color: var(--color-content-500);
    margin: 0;
  }

  .difficulty-badge {
    font-family: var(--font-title);
    font-size: 0.875rem;
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-md);
    white-space: nowrap;
  }

  .difficulty-fácil {
    background: #d4edda;
    color: #155724;
  }

  .difficulty-moderada {
    background: #fff3cd;
    color: #856404;
  }

  .difficulty-difícil {
    background: #f8d7da;
    color: #721c24;
  }

  .difficulty-muy-difícil {
    background: #d6d8db;
    color: #1b1e21;
  }

  .grade-badge {
    font-family: var(--font-title);
    font-size: 0.875rem;
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-md);
    background: var(--color-secondary-100);
    color: var(--color-secondary-500);
    white-space: nowrap;
  }

  .route-description {
    font-family: var(--font-paragraph);
    font-size: 0.95rem;
    color: var(--color-content-300);
    line-height: 1.6;
    margin: 0 0 1rem 0;
  }

  .route-stats {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    margin-bottom: 0.75rem;
  }

  .stat {
    font-family: var(--font-paragraph);
    font-size: 0.875rem;
    color: var(--color-content-300);
  }

  .stat strong {
    color: var(--color-content-400);
    font-weight: 600;
  }

  .view-more {
    font-family: var(--font-title);
    font-size: 0.875rem;
    color: var(--color-secondary-400);
    font-weight: 600;
  }

  /* Dark theme */
  :global([data-theme="dark"]) .route-card-link {
    background: var(--color-surface-200);
    border-color: var(--color-border-200);
  }

  :global([data-theme="dark"]) .route-card-link:hover {
    border-color: var(--color-secondary-300);
  }

  /* Responsive */
  @media (max-width: 968px) {
    .grid {
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    .sidebar {
      order: -1;
    }
  }
</style>
