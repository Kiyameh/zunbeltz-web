---
import { getCollection, type CollectionEntry } from "astro:content";
import HtmlLayout from "@/layouts/HtmlLayout.astro";
import type { MetaInfo } from "@/components/SEO/MetaInfo";
import ImageGallery from "@/components/navarra/shared/ImageGallery.astro";
import Breadcrumb from "@/components/ui/Breadcrumb.astro";
import HeroSection from "@/components/navarra/shared/HeroSection.astro";
import CaveProperties from "@/components/navarra/caves/CaveProperties.astro";
import CaveRouteProperties from "@/components/navarra/caves/CaveRouteProperties.astro";
import RestrictionsCard from "@/components/navarra/shared/RestrictionsCard.astro";
import LogisticCard from "@/components/navarra/shared/LogisticCard.astro";

export async function getStaticPaths() {
  const caves = await getCollection("caves");
  const cavingRoutes = await getCollection("cavingRoutes");
  return caves.map((cave) => {
    const relatedRoutes = cavingRoutes.filter(
      (route) => route.data.cave?.id === cave.slug,
    );
    return {
      params: { slug: cave.slug },
      props: { cave, relatedRoutes },
    };
  });
}

interface Props {
  cave: CollectionEntry<"caves">;
  relatedRoutes: CollectionEntry<"cavingRoutes">[];
}

const { cave, relatedRoutes } = Astro.props;
const { Content: CaveContent } = await cave.render();

const meta: MetaInfo = {
  pageTitle: `${cave.data.name} | Cuevas de Navarra | Zunbeltz`,
  pageDescription: cave.data.description,
  pageTags: ["Cueva", "Navarra", "Espeleología", cave.data.location],
  pageUrl: `https://zunbeltz.org/navarra/cuevas/${cave.slug}`,
};
---

<HtmlLayout metaInfo={meta}>
  <main>
    <article>
      <HeroSection
        title={cave.data.name}
        description={cave.data.description}
        photo={cave.data.mainPhoto}
      />

      <!-- Breadcrumb -->
      <div class="container">
        <Breadcrumb />
      </div>

      <div class="container">
        <!-- Cave info -->
        <div class="grid">
          <section class="main-column">
            <CaveProperties cave={cave.data} />
            <div class="markdown-content">
              <CaveContent />
            </div>
          </section>
          <aside class="side-column">
            <RestrictionsCard restrictions={cave.data.restrictions} />
            <LogisticCard
              entryPoint={cave.data.entryPoint}
              accessInfo={cave.data.accessInfo}
            />
            {
              relatedRoutes.length > 0 && (
                <>
                  <h4>Rutas:</h4>
                  {relatedRoutes.map((route) => {
                    return (
                      <a class="anchor" href={`#${route.slug}`}>
                        {route.data.name}
                      </a>
                    );
                  })}
                </>
              )
            }
          </aside>
        </div>

        <!-- Routes info -->
        {
          relatedRoutes.map(async (route) => {
            const { Content: RouteContent } = await route.render();
            return (
              <div>
                <hr class="content-separator" />
                <div class="grid">
                  <section id={route.slug} class="main-column">
                    <CaveRouteProperties route={route.data} />
                    <div class="markdown-content">
                      <RouteContent />
                    </div>
                  </section>
                  <aside class="side-column">
                    {/* Aquí podrían ir componentes específicos de rutas si los hubiera */}
                  </aside>
                </div>
              </div>
            );
          })
        }
      </div>

      <!-- Multimedia Section -->
      <ImageGallery photos={cave.data.additionalPhotos || []} />
    </article>
  </main>
</HtmlLayout>

<style>
  .container {
    max-width: 1300px;
    margin: 0 auto;
    padding: 0 1.5rem 3rem 1.5rem;
  }

  .grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 3rem;
  }

  .content-separator {
    margin: 1rem 0;
    border: none;
    border-top: 2px solid var(--color-border-100);
  }

  .main-column {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .side-column {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  /* Responsive */
  @media (max-width: 968px) {
    .grid {
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    .sidebar {
      order: -1;
    }

    .photo-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .multimedia {
      padding: 3rem 0;
    }

    .multimedia-title {
      font-size: 1.5rem;
    }
  }
</style>
