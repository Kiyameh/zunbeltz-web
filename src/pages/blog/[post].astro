---
import type { GetStaticPaths } from "astro";
import { Image } from "astro:assets";
import { getAllPosts } from "@/services/strapi/repositories/post.repo";
import {
  BlocksRenderer,
  type BlocksContent,
} from "@strapi/blocks-react-renderer";

import HtmlLayout from "@/layouts/HtmlLayout.astro";
import BlogLayout from "@/layouts/BlogLayout.astro";
import Breadcrumb from "@/components/ui/Breadcrumb.astro";
import PostHeader from "@/components/blog/PostHeader.astro";
import AuthorProfile from "@/components/blog/AuthorProfile.astro";
import type { MetaInfo } from "@/components/SEO/MetaInfo";
import ShareButtons from "@/components/SEO/ShareButtons";

export const getStaticPaths = (async () => {
  const posts = await getAllPosts();
  return posts.map((post) => ({
    params: { post: post.slug },
    props: { post },
  }));
}) satisfies GetStaticPaths;

const { post } = Astro.props;

if (post.content.kind === "markdown") {
  //TODO: Renederizador de markdown
}

const meta: MetaInfo = {
  pageTitle: `${post.title} | Blog Zunbeltz`,
  pageDescription: post.description,
  pageTags: post.categories.map((c) => c.name),
  pageAuthor: post.author?.name,
  pageImage: post.cover.href,
  pageUrl: `https://zunbeltz.org/blog/${post.slug}`,
  pageType: "article",
  articleAuthor: post.author?.name,
  articlePublishedTime: post.publishedAt.toISOString(),
  articleTags: post.categories.map((c) => c.name),
};
console.log(post);
---

<HtmlLayout metaInfo={meta}>
  <BlogLayout>
    <Breadcrumb />

    <!-- ! Indexado en pagefind -->
    <article class="article" data-pagefind-body>
      <!-- ! Metadatos para la indexación en pagefind -->
      <div class="pagefind-metadata">
        <span data-pagefind-filter="Tipo">Entrada de blog</span>
        <span data-pagefind-filter="Autor">{post.author?.name}</span>
        <span data-pagefind-meta="title">{post.title}</span>
        <span data-pagefind-meta="image">{post.cover.href}</span>
        <span data-pagefind-meta="image_alt">{post.title}</span>
      </div>

      <div class="hero-image">
        <Image
          src={post.cover.href}
          alt={post.title}
          width={1200}
          height={400}
          quality={80}
        />
      </div>

      <PostHeader post={post} data-pagefind-ignore />

      <div class="markdown-content">
        {
          post.content.kind === "blocks" && (
            <BlocksRenderer content={post.content.value as BlocksContent} />
          )
        }
      </div>

      <AuthorProfile author={post.author} data-pagefind-ignore />

      <div class="share-section" data-pagefind-ignore>
        <h3>Compartir este artículo</h3>
        <ShareButtons
          client:load
          url={meta.pageUrl || ""}
          title={post.title}
          description={post.description || ""}
        />
      </div>
    </article>
  </BlogLayout>
</HtmlLayout>

<style>
  .article {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .pagefind-metadata {
    display: none;
  }

  .hero-image {
    width: 100%;
    aspect-ratio: 16 / 5;
    overflow: hidden;
    background-color: var(--color-surface-300);
    border-radius: var(--radius-3xl);
    transition: scale 0.3s ease;
  }
  .hero-image:hover {
    scale: 1.02;
  }

  .hero-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .markdown-content {
    font-family: var(--font-paragraph);
    color: var(--color-content-300);
    line-height: 1.8;
    padding-bottom: 2rem;
    border-bottom: 2px solid var(--color-border-100);
  }

  .share-section {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 1.5rem 0;
  }

  .share-section h3 {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-content-300);
    margin: 0;
  }
</style>
